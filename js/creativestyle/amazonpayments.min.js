var AmazonPayments=function(selectorFn,serializer){var _extendObj=function(e,t){for(var r in t)e[r]=t[r];return this},_xhrCall=function(e,t,r,n,o,a){var i=new XMLHttpRequest;i.onreadystatechange=function(){switch(i.readyState){case XMLHttpRequest.OPENED:o&&o();break;case XMLHttpRequest.DONE:200===i.status?r&&r(i.responseText):n&&n(i.statusText),a&&a()}},i.open("post",e,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.send(t)},_getElementsBySelector=function(e){return selectorFn(e)},_getElementById=function(e){var t=_getElementsBySelector("#"+e);return t.length?t[0]:null},_getElementByName=function(e){var t=_getElementsBySelector(e);return t.length?t[0]:null},_evalJsScripts=function(html){for(var scripts=html.getElementsByTagName("script"),i=0;i<scripts.length;i++)eval(scripts[i].innerHTML)},_serializeForm=function(){var e=[];checkoutOrderReferenceId&&e.push("orderReferenceId="+checkoutOrderReferenceId);for(var t=0;t<arguments.length;t++){var r=_getElementById(arguments[t]);r&&e.push(serializer(r))}return e.join("&")},_setLoadWaiting=function(){for(var e=0;e<arguments.length;e++){var t=_getElementById(arguments[e]);if(t){var r=t.up("li");r&&r.addClassName("loading")}}},_unsetLoadWaiting=function(){for(var e=0;e<arguments.length;e++){var t=_getElementById(arguments[e]);if(t){var r=t.up("li");r&&r.removeClassName("loading")}}},_setFormLoadWaiting=function(){var e=_getElementById(config.pleaseWaitId);e&&e.show(),_showOverlay()},_unsetFormLoadWaiting=function(){var e=_getElementById(config.pleaseWaitId);e&&e.hide(),_hideOverlay()},_showOverlay=function(){var e=_getElementByName("body");e.insert('<div class="amazon-widget-overlay" id="'+config.amazonPleaseWaitOverlayId+'"></div>')},_hideOverlay=function(){var e=_getElementById(config.amazonPleaseWaitOverlayId);e&&e.remove()},config={live:!0,popup:!0,virtual:!1,pay:{selector:null,callbackUrl:null,design:null},login:{selector:null,callbackUrl:null,design:null},checkoutUrl:null,currency:null,debug:!1,scope:"profile payments:widget payments:shipping_address payments:billing_address",shippingMethodFormId:"co-shipping-method-form",discountCouponFormId:"discount-coupon-form",checkoutAgreementsFormId:"checkout-agreements",checkoutSubmitButtonId:"amazonpayments-checkout-place-order-button",simulationFormId:"sandbox-simulation",pleaseWaitId:"review-please-wait",amazonPleaseWaitOverlayId:"amazon-please-wait-overlay"},checkoutParams={responsive:!0,addressBook:"addressBookWidgetDiv",wallet:"walletWidgetDiv",shippingMethod:"shippingMethodWidgetDiv",review:"reviewWidgetDiv",urls:{}},checkoutOrderReferenceId=null,checkoutSubmitAllowed=!1,checkoutPaymentSelected=!1,addressBookWidget=null,walletWidget=null,errorCodes={clearOrderReference:["InvalidOrderReferenceId"],cancelOrderReference:["AddressNotModifiable","PaymentMethodNotModifiable"],redirect:["BuyerNotAssociated","BuyerSessionExpired","StaleOrderReference"]},_addressSelectCallback=function(){_setCheckoutPaymentSelected(!1),_xhrCall(checkoutParams.urls.saveShipping,_serializeForm(),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_setLoadWaiting(checkoutParams.shippingMethod,checkoutParams.review)},function(){_unsetLoadWaiting(checkoutParams.shippingMethod,checkoutParams.review)})},_orderReferenceCreateCallback=function(e){checkoutOrderReferenceId||(setOrderReferenceId(e.getAmazonOrderReferenceId()),config.virtual||_renderWalletWidget())},_paymentSelectCallback=function(){_setCheckoutPaymentSelected(!0)},_shippingMethodSelectCallback=function(){_xhrCall(checkoutParams.urls.saveShippingMethod,_serializeForm(config.shippingMethodFormId),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_setLoadWaiting(checkoutParams.review)},function(){_unsetLoadWaiting(checkoutParams.review)})},_signInCallback=function(e){var t=document.createElement("input");t.setAttribute("type","hidden"),t.setAttribute("name","orderReferenceId"),t.setAttribute("value",e.getAmazonOrderReferenceId());var r=document.createElement("form");r.setAttribute("method","post"),r.setAttribute("action",config.checkoutUrl),r.appendChild(t),document.body.appendChild(r),r.submit()},_widgetErrorCallback=function(e){config.debug&&alert("["+e.getErrorCode()+"]: "+e.getErrorMessage()),errorCodes.clearOrderReference.some(function(t){return t===e.getErrorCode()})&&(window.location.href=checkoutParams.urls.clearOrderReference||checkoutParams.urls.failure),errorCodes.cancelOrderReference.some(function(t){return t===e.getErrorCode()})&&(window.location.href=checkoutParams.urls.cancelOrderReference||checkoutParams.urls.failure),errorCodes.redirect.some(function(t){return t===e.getErrorCode()})&&(window.location.href=checkoutParams.urls.failure)},_xhrErrorCallback=function(e){config.debug&&alert(e.statusText),e.getResponseHeader("Login-Required")&&checkoutParams.urls.failure&&(window.location=checkoutParams.urls.failure)},_xhrSuccessCallback=function(e){_handleXhrResponse(e)},callbacks={onAddressSelect:_addressSelectCallback,onButtonError:_widgetErrorCallback,onOrderReferenceCreate:_orderReferenceCreateCallback,onPaymentSelect:_paymentSelectCallback,onShippingMethodSelect:_shippingMethodSelectCallback,onSignIn:_signInCallback,onWidgetError:_widgetErrorCallback,onXhrError:_xhrErrorCallback,onXhrSuccess:_xhrSuccessCallback},_setCheckoutSubmitAllowed=function(e){checkoutSubmitAllowed=e,_updateCheckoutSubmitButtonState()},_setCheckoutPaymentSelected=function(e){checkoutPaymentSelected=e,_updateCheckoutSubmitButtonState()},_updateCheckoutSubmitButtonState=function(){var e=document.getElementById(config.checkoutSubmitButtonId);e&&(e.disabled=!checkoutSubmitAllowed||!checkoutPaymentSelected)},_handleXhrResponse=function(e){e=JSON.parse(e),e.error&&_handleXhrErrorResponse(e),e.redirect&&(window.location=e.redirect),e.render_widget&&(e.render_widget["shipping-method"]&&_renderShippingMethod(e.render_widget["shipping-method"]),e.render_widget.review&&_renderReview(e.render_widget.review)),e.disable_widget&&e.disable_widget["address-book"]&&_renderAddressBookWidget("Read"),_setCheckoutSubmitAllowed(e.allow_submit),e.deselect_payment&&_setCheckoutPaymentSelected(!1)},_handleXhrErrorResponse=function(e){e.error_messages&&("object"!=typeof e.error_messages?alert(e.error_messages):alert(e.error_messages.join("\n")))},_getDisplayMode=function(e){return e?e:"Edit"},_renderAddressBookWidget=function(e){return e=_getDisplayMode(e),addressBookWidget=new OffAmazonPayments.Widgets.AddressBook({sellerId:config.merchantId,displayMode:e,onOrderReferenceCreate:"Edit"===e?callbacks.onOrderReferenceCreate:null,amazonOrderReferenceId:checkoutOrderReferenceId,design:checkoutParams.responsive?{designMode:"responsive"}:checkoutParams.addressBook,onAddressSelect:"Edit"===e?callbacks.onAddressSelect:null,onError:callbacks.onWidgetError}),addressBookWidget.bind(checkoutParams.addressBook),this},_renderWalletWidget=function(){return walletWidget=new OffAmazonPayments.Widgets.Wallet({sellerId:config.merchantId,onOrderReferenceCreate:callbacks.onOrderReferenceCreate,amazonOrderReferenceId:checkoutOrderReferenceId,design:checkoutParams.responsive?{designMode:"responsive"}:checkoutParams.wallet,onPaymentSelect:callbacks.onPaymentSelect,onError:callbacks.onWidgetError}),walletWidget.bind(checkoutParams.wallet),this},_renderShippingMethod=function(e){var t=_getElementById(checkoutParams.shippingMethod);if(t){if(t.onchange=callbacks.onShippingMethodSelect,t.innerHTML=e,_evalJsScripts(t),!t.down("input[type=radio]:checked")){var r=t.down("input[type=radio]");r&&(r.checked=!0)}callbacks.onShippingMethodSelect()}return this},_renderReview=function(e){var t=_getElementById(checkoutParams.review);return t&&(t.innerHTML=e,_evalJsScripts(t)),this},saveOrder=function(){_setCheckoutSubmitAllowed(!1),_xhrCall(checkoutParams.urls.saveOrder,_serializeForm(config.checkoutAgreementsFormId,config.shippingMethodFormId,config.simulationFormId),callbacks.onXhrSuccess,callbacks.onXhrError,_setFormLoadWaiting,_unsetFormLoadWaiting)},submitCoupon=function(e){_setCheckoutSubmitAllowed(!1),_xhrCall(checkoutParams.urls.saveCoupon,e?_serializeForm(config.discountCouponFormId)+"&remove=1":_serializeForm(config.discountCouponFormId),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_showOverlay(),_setLoadWaiting(checkoutParams.review)},function(){_hideOverlay(),_unsetLoadWaiting(checkoutParams.review)})},initCheckout=function(e){_extendObj(checkoutParams,e),_setCheckoutSubmitAllowed(!1),config.virtual?(_renderWalletWidget(),_setCheckoutSubmitAllowed(!0)):(_renderAddressBookWidget(),checkoutOrderReferenceId&&_renderWalletWidget())},logout=function(){amazon.Login.logout(),Mage.Cookies.clear("amazon_Login_accessToken")},initLogin=function(){return amazon.Login.setClientId(config.clientId),amazon.Login.setUseCookie(!0),this},renderButtons=function(){var e=null;if(config.pay.selector){var t=_getElementsBySelector(config.pay.selector);if(config.pay&&config.pay.callbackUrl)for(var r=0;r<t.length;r++)e=t[r],e&&new OffAmazonPayments.Button(e.id,config.merchantId,{type:e.buttonType||config.pay.design&&config.pay.design.type||"PwA",size:e.buttonSize||config.pay.design&&config.pay.design.size||"small",color:e.buttonColor||config.pay.design&&config.pay.design.color||"Gold",language:config.language,onError:callbacks.onButtonError,authorization:function(){amazon.Login.authorize({scope:config.scope,popup:config.popup},config.pay.callbackUrl)}});else for(var r=0;r<t.length;r++)e=t[r],e&&new OffAmazonPayments.Widgets.Button({sellerId:config.merchantId,useAmazonAddressBook:!config.virtual,onSignIn:callbacks.onSignIn,onError:callbacks.onButtonError}).bind(e.id)}if(config.login&&config.login.selector)for(var n=_getElementsBySelector(config.login.selector),r=0;r<n.length;r++)e=n[r],e&&new OffAmazonPayments.Button(e.id,config.merchantId,{type:e.buttonType||config.login.design&&config.login.design.type||"LwA",size:e.buttonSize||config.login.design&&config.login.design.size||"small",color:e.buttonColor||config.login.design&&config.login.design.color||"Gold",language:config.language,onError:callbacks.onButtonError,authorization:function(){amazon.Login.authorize({scope:config.scope,popup:config.popup},config.login.callbackUrl)}});return this},setOrderReferenceId=function(e){return checkoutOrderReferenceId=e,this},setup=function(e){return _extendObj(config,e),this};return{setup:setup,setOrderReferenceId:setOrderReferenceId,renderButtons:renderButtons,initLogin:initLogin,logout:logout,initCheckout:initCheckout,submitCoupon:submitCoupon,saveOrder:saveOrder}}($$,Form.serialize);